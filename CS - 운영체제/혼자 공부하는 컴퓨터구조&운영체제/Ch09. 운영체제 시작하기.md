# Ch09. 운영체제 시작하기

> 혼자공부하는 컴퓨터구조 + 운영체제

## 09-1. 운영체제를 알아야 하는 이유

### 운영체제란

모든 프로그램은 하드웨어를 필요로 하고, 프로그램 실행에 필요한 요소들을 **시스템 자원**이라고 한다. 여기서 실행할 프로그램에 필요한 **자원**을 할당하고, 프로그램이 올바르게 실행되도록 돕는 프로그램이 **운영체제**

운영체제는 매우 특별한 프로그램이기 때문에 컴퓨터가 부팅될 때 메모리 내 **커널영역**에 따로 적재되어 실행.

커널영역을 제외한 나머지 영역을 **사용자영역**이라고 하며 사용자가 이용하는 응용프로그램이 적재된다.

즉, "운영체제는 커널영역에 적재되어 사용자영역에 적재된 응용프로그램들에 자원을 할당하고 올바르게 실행되도록 돕는다."

**메모리 자원 관리**

프로그램들은 각각 다른 메모리 주소에 적재가 되는데, 주소가 겹치지 않도록 적당한 공간에 프로그램들을 적재하고, 더 이상 실행하지 않는 프로그램을 메모리에서 삭제하며 지속적으로 메모리 자원을 관리

**CPU 자원 할당**

어느 한 프로그램이 CPU를 독점하면 다른 프로그램들은 올바르게 실행될 수 없기 때문에 운영체제는 최대한 공정하게 여러 프로그램에 CPU 자원을 할당한다.

**외부 입출력 자원 관리**

프린터 사용하는 상황. 운영체제는 동시에 두 개의 프로그램이 프린터를 사용하지 못하도록 막고, 하나의 프로그램이 프린터를 이용하는 동안 다른 프로그램은 기다리게 만들어 프린터 자원 관리

### 운영체제를 알아야 하는 이유

간단한 프로그램이라도 운영체제가 없으면, 개발자가 하드웨어를 조작하는 코드를 모두 직접 작성해야 한다.

운영체제를 알면, 운영체제가 개발자에게 전달하고자 하는 말을 제대로 이해할 수 있게 되고, 운영체제에 적절한 명령을 내릴 수 있게 된다. 그렇게 되면 하드웨어와 프로그램을 더 깊이 이해할 수 있게 된다.



## 09-2. 운영체제의 큰 그림

### 운영체제의 심장, 커널

운영체제의 핵심이 되는 컴퓨터 프로그램. 시스템의 모든 것을 완전히 통제.

<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Kernel_Layout.svg/200px-Kernel_Layout.svg.png">

운영체제가 제공하는 서비스 중 커널에 포함되지 않는 서비스도 있다.

대표적으로 UI 가 있다. (GUI:Graphical User Interface / CLI: Command Line Interface)

### 이중 모드와 시스템 호출

운영체제는 응용프로그램이 자원에 접근하려고 할 때 오직 자신을 통해서만 접근하도록 하여 자원을 보호한다.

**이중 모드(dual mode)** : CPU가 명령어를 실행하는 모드를 크게 사용자모드와 커널모드로 구분하는 방식

**사용자 모드 (User mode)** : 운영체제 서비스를 제공 받을 수 없는 실행 모드

**커널 모드 (Kernel mode)** : 운영체제 서비스를 제공 받을 수 있는 실행 모드. 커널모드로 명령어를 실행하면 자원에 접근하는 명령어를 비롯한 모든 명령어 실행 가능.

**시스템 호출 (System Call)** : 사용자 모드로 실행되는 프로그램이 자원에 접근하는 운영체제 서비스를 제공받으려면 운영체제에 요청을 보내 커널모드로 전환되어야 하는데, 이 때 운영체제 서비스를 제공받기 위한 요청.

시스템 호출은 일종의 소프트웨어 인터럽트.

 ```
 시스템 호출을 발생시키는 명령어가 실행되면
 CPU는 지금까지의 작업을 백업하고
 커널 영역 내에 시스템 호출을 수행하는 코드 (인터럽트 서비스 루틴)를 실행한 뒤
 다시 기존에 실행하더 응용 프로그램으로 복귀하여 실행을 계속해 나간다.
 ```

사용자 모드의 응용프로그램에서 시스템 호출을 통해 커널 모드로 전환하고, 커널모드에서 운영체제 내의 접근 코드를 실행하여 자원에 접근 후 다시 사용자 모드로 복귀하여 실행 계속

---

#### 이중 모드 (Dual Mode)

다중 프로그래밍 환경에서 자원에 대한 접근을 사용자 모드 (User Mode)와 커널 모드 (Kernel Mode)로 분리하여 운영체제를 보호하는 기법

**이중 모드의 구조**

<img src="http://blog.skby.net/blog/wp-content/uploads/2021/10/%EC%9D%B4%EC%A4%91%EB%AA%A8%EB%93%9C_%EA%B5%AC%EC%A1%B0.png">

User Mode에서 생성된 User Application은 System Call Interface를 통해 Kernel Mode로 전환된다. Kernel Mode에서 System 권한이 필요한 작업이 끝나면 다시 User Mode로 전환

**이중 모드의 종류**

User Mode : 사용자 애플리케이션 코드 실행. 시스템에 제한된 접근만 허용, 하드웨어 직접 접근 불가. 시스템 콜 수행 시 사용자 모드에서 커널 모드로 전환

Kernel Mode : 커널 모드에서 OS는 모든 하드웨어 접근 및 제어 가능. 시스템의 모든 메모리에 접근 및 모든 CPU 명령 실행 가능. 일부 명령어는 커널 모드 특권(Privileged) 수준 코드 실행

**이중 모드의 구현**

User Mode에서 프로그램 실행 (open() : 사용자가 Application 실행)

운영체제의 커널에서 시스템 콜 수행 - Kernel Mode로 전환

커널에서 요청 작업 수행 후 결과 반환

open() 함수 이후 프로그램을 계속 수행

---

### 운영체제의 핵심 서비스

> 프로세스 관리, 자원 접근 및 할당, 파일 시스템 관리

#### 프로세스 관리

**프로세스** : 실행 중인 프로그램

일반적으로 하나의 CPU는 한 번에 하나의 프로세스만 실행할 수 있기에 CPU는 이 프로세스들을 조금씩 번갈아가며 실행한다.

이 프로세스는  각자 상태도, 사용하고자 하는자원도 다양하다. (입출력장치를 주로 사용하는 프로세스, 주로 CPU만 사용하는 프로세스, 즉시 실행 가능한 프로세스, 즉시 실행이 불가능한 프로세스 등)

운영체제는 다양한 프로세스를 일목 요연하게 관리하고 실행할 수 있어야 한다.  이 관리 방법은 10장에서 설명

#### 자원 접근 및 할당

운영체제는 프로세스들이 사용할 자원에 접근하고 조작함으로써 프로세스에 필요한 자원을 할당해준다.

운영체제가 CPU , 메모리 , 입출력장치를 어떻게 관리하고 결과적으로 어떤 기능을 제공하는지 알아보자.

**CPU**

운영체제는 CPU를 각 프로세스에 공정하게 할당하기 위해 어떤 프로세스로부터 CPU를 이용하게 할 것인지, 얼마나 오래 CPU를 이용하게 할지를 결정할 수 있어야 한다 이를 CPU 스케쥴링이라 한다.

**메모리**

메모리에 적재된 프로세스들은 크기도 적재되는 주소도 가지각색. 같은 프로세스라도 적재 주소가 달라질 수 있다.

그래서 운영체제는 새로운 프로세스가 적재될 때마다 어느 주소에 적재할지 결정해야하고, 메모리 공간이 없는 경우나 메모리 공간이 있음에도 프로세스를 적재할 수 없는 상황도 발생할 수 있다.

운영체제가 어떻게 이를 처리하고 극복하는지 14장에서 자세히 다룰 예정

**입출력 장치**

인터럽트 서비스 루틴은 운영체제가 제공하는 기능으로 커널 영역에 있다. 입출력 장치가 발생 시키는 하드웨어 인터럽트도 마찬가지. 입출력장치가 CPU에 하드웨어 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업한 뒤 커널 영역에 있는 인터럽트 서비스 루틴을 실행한다. 이처럼 운영체제는 인터럽트를 처리하는 프로그램, 즉 인터럽트 서비스 루틴을 제공함으로써 입출력 작업을 수행한다.

#### 파일 시스템 관리

여러 파일을 열고, 생성하고, 삭제하고, 한데 묶어 디렉터리로 관리하는 작업들도 운영체제가 지원하는 핵심 서비스. 15장에서 다룰 예정

### [좀 더 알아보기]

#### 가상 머신과 이중 모드의 발전

이중모드는 커널 / 사용자 모드를 지원하는 실행모드이지만

가상 머신을 통한 가상화를 지원하는 현대 CPU는 두가지 모드 이상을 지원한다.

**가상 머신** : 소프트웨어 적으로 만들어낸 가상 컴퓨터. 

**하이퍼 바이저 모드** : 가상화를 지원하는 CPU는 커널 모드와 사용자 모드 이외에 가상 머신을 위한 모드를 따로 둠으로써, 가상 머신 상에서 작동하는 응용프로그램들은 하이퍼바이저 모드로써 가상머신에 설치된 운영체제로부터 운영체제 서비스를 받을 수 있게 된다.